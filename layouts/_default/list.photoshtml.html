{{ define "main" }}
<main class="photos content" aria-label="Foto-Archiv">
  <style>
    :root {
      --gap: 8px;
      --column-width: 280px;
      --max-width: 1400px;
      --radius: 6px;
    }

    .photos.content {
      overscroll-behavior-y: contain;
      -webkit-tap-highlight-color: transparent;
    }

    /* Masonry Grid Container */
    .photo-grid {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--gap);
    }

    /* Masonry wird die Positionierung übernehmen */
    .photo-grid::after {
      content: '';
      display: block;
      clear: both;
    }

    @media (max-width: 768px) {
      :root {
        --gap: 6px;
        --column-width: 200px;
      }
    }

    @media (max-width: 480px) {
      :root {
        --gap: 4px;
        --column-width: 160px;
      }
    }

    /* Photo Tiles - Masonry Items */
    .photo-tile {
      width: var(--column-width);
      margin-bottom: var(--gap);
      position: relative;
      overflow: hidden;
      background: #f3f4f6;
      cursor: pointer;
      border-radius: var(--radius);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: block;
    }

    .photo-tile:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(0,0,0,.2);
      z-index: 10;
    }

    .photo-tile:active {
      transform: translateY(-2px);
    }

    .photo-tile img {
      width: 100%;
      height: auto;
      display: block;
      transition: opacity 0.3s ease;
    }

    /* LQIP Blur Effect */
    .photo-tile img.lqip {
      filter: blur(10px);
      transform: scale(1.05);
    }

    .photo-tile img.loaded {
      filter: none;
      transform: scale(1);
    }

    /* Hover Overlay */
    .photo-tile::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, transparent 60%, rgba(0,0,0,.5) 100%);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }

    .photo-tile:hover::after {
      opacity: 1;
    }

    /* Date Badge */
    .date-badge {
      position: absolute;
      bottom: 0.5rem;
      left: 0.5rem;
      padding: 0.35rem 0.6rem;
      font-size: 0.75rem;
      line-height: 1;
      color: #fff;
      background: rgba(0,0,0,.7);
      border-radius: 4px;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
      backdrop-filter: blur(4px);
    }

    .photo-tile:hover .date-badge {
      opacity: 1;
      transform: translateY(0);
    }

    /* Loading Indicator */
    .loading-indicator {
      text-align: center;
      padding: 2rem;
      color: #666;
      font-size: 0.9rem;
    }

    /* Focus States */
    .photo-tile:focus-visible {
      outline: 3px solid #3b82f6;
      outline-offset: 2px;
    }

    @media (prefers-color-scheme: dark) {
      .photo-tile {
        background: #1f2937;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .photo-tile,
      .photo-tile img,
      .date-badge {
        transition: none;
      }
    }
  </style>

  <div class="photo-grid" id="photoGrid">
    {{ $pages := sort (where .Site.RegularPages "Type" "in" (slice "post" "photo")) "Date" "desc" }}
    {{ $imageIndex := 0 }}

    {{ range $p := $pages }}
      {{ $dateFormatted := $p.Date.Format "2. January 2006" }}
      {{ $dateISO := $p.Date.Format "2006-01-02" }}
      {{ $year := $p.Date.Format "2006" }}

      {{ with $p.Params.photos }}
        {{ range $i, $url := . }}
          {{ $eager := lt $imageIndex 12 }}
          {{ $isMBPhotos := or (hasPrefix $url "https://micro.blog/photos/") (hasPrefix $url "http://micro.blog/photos/") }}
          {{ $src300 := "" }}{{ $src600 := "" }}{{ $tiny := "" }}

          {{ if $isMBPhotos }}
            {{ $src300 = replaceRE `/photos/[^/]+/` "/photos/300w/" $url }}
            {{ $src600 = replaceRE `/photos/[^/]+/` "/photos/600w/" $url }}
            {{ $tiny = replaceRE `/photos/[^/]+/` "/photos/40w/" $url }}
          {{ else }}
            {{ $encoded := $url | urlquery }}
            {{ $src300 = printf "https://micro.blog/photos/300w/%s" $encoded }}
            {{ $src600 = printf "https://micro.blog/photos/600w/%s" $encoded }}
            {{ $tiny = printf "https://micro.blog/photos/40w/%s" $encoded }}
          {{ end }}

          <a class="photo-tile"
             href="{{ $p.RelPermalink }}"
             aria-label="{{ $dateFormatted }}"
             data-date="{{ $dateFormatted }}"
             data-year="{{ $year }}">
            {{ if $eager }}
              <img
                src="{{ $src300 }}"
                srcset="{{ $src300 }} 300w, {{ $src600 }} 600w"
                sizes="(max-width: 480px) 160px, (max-width: 768px) 200px, 280px"
                alt="{{ $dateFormatted }}"
                loading="eager"
                decoding="async"
                class="loaded">
            {{ else }}
              <img
                src="{{ $tiny }}"
                data-src="{{ $src300 }}"
                data-srcset="{{ $src300 }} 300w, {{ $src600 }} 600w"
                sizes="(max-width: 480px) 160px, (max-width: 768px) 200px, 280px"
                alt="{{ $dateFormatted }}"
                decoding="async"
                class="lqip">
            {{ end }}
            <span class="date-badge">{{ $dateFormatted }}</span>
          </a>

          {{ $imageIndex = add $imageIndex 1 }}
        {{ end }}
      {{ end }}

      {{ $imgs := $p.Resources.ByType "image" }}
      {{ range $img := $imgs }}
        {{ $name := $img.Name | lower }}
        {{ if not (or (hasPrefix $name "hero") (in $name "og-") (in $name "open-graph") (in $name "social") (in $name "thumb")) }}
          {{ $w300 := $img.Resize "300x q85" }}
          {{ $w600 := $img.Resize "600x q85" }}
          {{ $w40 := $img.Resize "40x q50" }}
          {{ $eager := lt $imageIndex 12 }}

          <a class="photo-tile"
             href="{{ $p.RelPermalink }}"
             aria-label="{{ $dateFormatted }}"
             data-date="{{ $dateFormatted }}"
             data-year="{{ $year }}">
            {{ if $eager }}
              <img
                src="{{ $w300.RelPermalink }}"
                srcset="{{ $w300.RelPermalink }} 300w, {{ $w600.RelPermalink }} 600w"
                sizes="(max-width: 480px) 160px, (max-width: 768px) 200px, 280px"
                alt="{{ $dateFormatted }}"
                loading="eager"
                decoding="async"
                class="loaded">
            {{ else }}
              <img
                src="{{ $w40.RelPermalink }}"
                data-src="{{ $w300.RelPermalink }}"
                data-srcset="{{ $w300.RelPermalink }} 300w, {{ $w600.RelPermalink }} 600w"
                sizes="(max-width: 480px) 160px, (max-width: 768px) 200px, 280px"
                alt="{{ $dateFormatted }}"
                decoding="async"
                class="lqip">
            {{ end }}
            <span class="date-badge">{{ $dateFormatted }}</span>
          </a>

          {{ $imageIndex = add $imageIndex 1 }}
        {{ end }}
      {{ end }}
    {{ end }}
  </div>

  <!-- Masonry.js -->
  <script src="https://unpkg.com/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
  <script src="https://unpkg.com/imagesloaded@5.0.0/imagesloaded.pkgd.min.js"></script>

  <script>
    (function() {
      'use strict';

      const grid = document.querySelector('.photo-grid');
      if (!grid) return;

      // Masonry initialisieren
      const msnry = new Masonry(grid, {
        itemSelector: '.photo-tile',
        columnWidth: '.photo-tile',
        gutter: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 8,
        percentPosition: false,
        transitionDuration: '0.3s',
        initLayout: true
      });

      // Lazy Loading für Bilder außerhalb des Viewports
      const lazyImages = document.querySelectorAll('img.lqip[data-src]');
      let loadingCount = 0;
      const maxConcurrent = 6;

      function loadImage(img) {
        if (img.dataset.loading || !img.dataset.src) return;

        img.dataset.loading = 'true';
        loadingCount++;

        const src = img.dataset.src;
        const srcset = img.dataset.srcset;
        const tile = img.closest('.photo-tile');

        const fullImg = new Image();
        fullImg.onload = () => {
          img.src = src;
          if (srcset) img.srcset = srcset;
          img.classList.remove('lqip');
          img.classList.add('loaded');

          delete img.dataset.src;
          delete img.dataset.srcset;
          delete img.dataset.loading;

          loadingCount--;

          // Masonry Layout nach Bildladen aktualisieren
          if (tile) {
            imagesLoaded(tile, function() {
              msnry.layout();
            });
          }
        };

        fullImg.onerror = () => {
          delete img.dataset.loading;
          loadingCount--;
        };

        if (srcset) fullImg.srcset = srcset;
        fullImg.src = src;
      }

      // IntersectionObserver für Lazy Loading
      const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && loadingCount < maxConcurrent) {
            const img = entry.target;
            if (img.dataset.src && !img.dataset.loading) {
              loadImage(img);
            }
          }
        });
      }, {
        rootMargin: '200px 0px',
        threshold: 0.01
      });

      // Beobachte alle lazy Images
      lazyImages.forEach(img => imageObserver.observe(img));

      // Initial Layout nach dem Laden aller eager Bilder
      imagesLoaded(grid, function() {
        msnry.layout();
      });

      // Layout bei Fenstergrößenänderung aktualisieren
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          // Gutter neu berechnen
          const newGutter = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 8;
          msnry.options.gutter = newGutter;
          msnry.layout();
        }, 250);
      });

      // Cleanup
      window.addEventListener('beforeunload', () => {
        imageObserver.disconnect();
      });
    })();
  </script>
</main>
{{ end }}
