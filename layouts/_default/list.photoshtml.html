{{ define "main" }}
<main class="photos content" aria-label="Foto-Archiv">
  <style>
    /* CSS Variablen */
    :root {
      --gap: 16px;
      --column-width: 300px;
      --max-width: 1400px;
      --radius: 8px;
      --transition-speed: 0.2s;
    }

    @media (max-width: 768px) {
      :root {
        --gap: 12px;
        --column-width: 200px;
        --radius: 6px;
      }
    }

    @media (max-width: 480px) {
      :root {
        --gap: 8px;
        --column-width: calc(50vw - 12px);
      }
    }

    /* Main Container */
    .photos.content {
      overscroll-behavior-y: contain;
      -webkit-tap-highlight-color: transparent;
    }

    /* Masonry Grid */
    .photo-grid {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--gap);
    }

    /* Photo Tiles */
    .photo-tile {
      width: var(--column-width);
      margin-bottom: var(--gap);
      position: relative;
      overflow: hidden;
      background: #f8f9fa;
      cursor: pointer;
      border-radius: var(--radius);
      transition: transform var(--transition-speed) ease,
                  box-shadow var(--transition-speed) ease;
      display: block;
      text-decoration: none;
    }

    .photo-tile:hover {
      transform: translateY(-6px);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);
      z-index: 10;
    }

    .photo-tile:active {
      transform: translateY(-3px);
    }

    /* Photo Images */
    .photo-tile img {
      width: 100%;
      height: auto;
      display: block;
      transition: opacity 0.3s ease, filter 0.3s ease;
    }

    /* LQIP (Low Quality Image Placeholder) */
    .photo-tile img.lqip {
      filter: blur(15px);
      transform: scale(1.1);
    }

    .photo-tile img.loaded {
      filter: none;
      transform: scale(1);
    }

    /* Hover Overlay */
    .photo-tile::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(
        180deg,
        transparent 50%,
        rgba(0, 0, 0, 0.6) 100%
      );
      opacity: 0;
      transition: opacity var(--transition-speed) ease;
      pointer-events: none;
      z-index: 1;
    }

    .photo-tile:hover::before {
      opacity: 1;
    }

    /* Date Badge */
    .date-badge {
      position: absolute;
      bottom: 12px;
      left: 12px;
      padding: 6px 10px;
      font-size: 0.75rem;
      font-weight: 500;
      line-height: 1.2;
      color: #ffffff;
      background: rgba(0, 0, 0, 0.75);
      border-radius: 6px;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity var(--transition-speed) ease,
                  transform var(--transition-speed) ease;
      pointer-events: none;
      backdrop-filter: blur(8px);
      z-index: 2;
      white-space: nowrap;
    }

    .photo-tile:hover .date-badge {
      opacity: 1;
      transform: translateY(0);
    }

    /* Focus States fÃ¼r Accessibility */
    .photo-tile:focus-visible {
      outline: 3px solid #3b82f6;
      outline-offset: 3px;
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      .photo-tile {
        background: #1f2937;
      }
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      .photo-tile,
      .photo-tile img,
      .photo-tile::before,
      .date-badge {
        transition: none;
      }
    }

    /* Loading State */
    .photo-grid.loading {
      min-height: 100vh;
    }
  </style>

  <div class="photo-grid" id="photoGrid">
    {{ $pages := sort (where .Site.RegularPages "Type" "in" (slice "post" "photo")) "Date" "desc" }}
    {{ $imageIndex := 0 }}

    {{ range $p := $pages }}
      {{ $dateFormatted := $p.Date.Format "2. January 2006" }}
      {{ $dateISO := $p.Date.Format "2006-01-02" }}
      {{ $year := $p.Date.Format "2006" }}

      {{/* Micro.blog Photos */}}
      {{ with $p.Params.photos }}
        {{ range $i, $url := . }}
          {{ $eager := lt $imageIndex 8 }}
          {{ $isMBPhotos := or (hasPrefix $url "https://micro.blog/photos/") (hasPrefix $url "http://micro.blog/photos/") }}
          {{ $src300 := "" }}{{ $src600 := "" }}{{ $tiny := "" }}

          {{ if $isMBPhotos }}
            {{ $src300 = replaceRE `/photos/[^/]+/` "/photos/300w/" $url }}
            {{ $src600 = replaceRE `/photos/[^/]+/` "/photos/600w/" $url }}
            {{ $tiny = replaceRE `/photos/[^/]+/` "/photos/40w/" $url }}
          {{ else }}
            {{ $encoded := $url | urlquery }}
            {{ $src300 = printf "https://micro.blog/photos/300w/%s" $encoded }}
            {{ $src600 = printf "https://micro.blog/photos/600w/%s" $encoded }}
            {{ $tiny = printf "https://micro.blog/photos/40w/%s" $encoded }}
          {{ end }}

          <a class="photo-tile"
             href="{{ $p.RelPermalink }}"
             aria-label="Foto vom {{ $dateFormatted }}"
             data-date="{{ $dateFormatted }}"
             data-year="{{ $year }}">
            {{ if $eager }}
              <img
                src="{{ $src300 }}"
                srcset="{{ $src300 }} 300w, {{ $src600 }} 600w"
                sizes="(max-width: 480px) calc(50vw - 12px), (max-width: 768px) 200px, 300px"
                alt="Foto vom {{ $dateFormatted }}"
                loading="eager"
                decoding="async"
                class="loaded">
            {{ else }}
              <img
                src="{{ $tiny }}"
                data-src="{{ $src300 }}"
                data-srcset="{{ $src300 }} 300w, {{ $src600 }} 600w"
                sizes="(max-width: 480px) calc(50vw - 12px), (max-width: 768px) 200px, 300px"
                alt="Foto vom {{ $dateFormatted }}"
                loading="lazy"
                decoding="async"
                class="lqip">
            {{ end }}
            <span class="date-badge">{{ $dateFormatted }}</span>
          </a>

          {{ $imageIndex = add $imageIndex 1 }}
        {{ end }}
      {{ end }}

      {{/* Page Bundle Images */}}
      {{ $imgs := $p.Resources.ByType "image" }}
      {{ range $img := $imgs }}
        {{ $name := $img.Name | lower }}
        {{ if not (or (hasPrefix $name "hero") (in $name "og-") (in $name "open-graph") (in $name "social") (in $name "thumb")) }}
          {{ $w300 := $img.Resize "300x q85" }}
          {{ $w600 := $img.Resize "600x q85" }}
          {{ $w40 := $img.Resize "40x q50" }}
          {{ $eager := lt $imageIndex 8 }}

          <a class="photo-tile"
             href="{{ $p.RelPermalink }}"
             aria-label="Foto vom {{ $dateFormatted }}"
             data-date="{{ $dateFormatted }}"
             data-year="{{ $year }}">
            {{ if $eager }}
              <img
                src="{{ $w300.RelPermalink }}"
                srcset="{{ $w300.RelPermalink }} 300w, {{ $w600.RelPermalink }} 600w"
                sizes="(max-width: 480px) calc(50vw - 12px), (max-width: 768px) 200px, 300px"
                alt="Foto vom {{ $dateFormatted }}"
                loading="eager"
                decoding="async"
                class="loaded">
            {{ else }}
              <img
                src="{{ $w40.RelPermalink }}"
                data-src="{{ $w300.RelPermalink }}"
                data-srcset="{{ $w300.RelPermalink }} 300w, {{ $w600.RelPermalink }} 600w"
                sizes="(max-width: 480px) calc(50vw - 12px), (max-width: 768px) 200px, 300px"
                alt="Foto vom {{ $dateFormatted }}"
                loading="lazy"
                decoding="async"
                class="lqip">
            {{ end }}
            <span class="date-badge">{{ $dateFormatted }}</span>
          </a>

          {{ $imageIndex = add $imageIndex 1 }}
        {{ end }}
      {{ end }}
    {{ end }}
  </div>

  <!-- Masonry.js von unpkg CDN (GitHub Repository) -->
  <script src="https://unpkg.com/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
  <script src="https://unpkg.com/imagesloaded@5.0.0/imagesloaded.pkgd.min.js"></script>

  <script>
    (function() {
      'use strict';

      const grid = document.getElementById('photoGrid');
      if (!grid) return;

      // Masonry Konfiguration
      const masonryOptions = {
        itemSelector: '.photo-tile',
        columnWidth: '.photo-tile',
        gutter: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 16,
        percentPosition: false,
        transitionDuration: '0.3s',
        horizontalOrder: false,
        initLayout: false  // Wir triggern das Layout manuell nach Bildladen
      };

      // Masonry initialisieren
      const masonry = new Masonry(grid, masonryOptions);

      // Lazy Loading Setup
      let loadingCount = 0;
      const maxConcurrent = 8;  // Max gleichzeitig ladende Bilder

      /**
       * LÃ¤dt ein einzelnes Bild mit LQIP-Effekt
       */
      function loadImage(img) {
        if (img.dataset.loading || img.classList.contains('loaded')) return;

        img.dataset.loading = 'true';
        loadingCount++;

        const src = img.dataset.src;
        const srcset = img.dataset.srcset;

        // Neues Image Objekt zum Vorladen
        const tempImg = new Image();

        tempImg.onload = () => {
          // Bild ist geladen - jetzt austauschen
          img.src = src;
          if (srcset) img.srcset = srcset;
          img.classList.remove('lqip');
          img.classList.add('loaded');

          // Cleanup
          delete img.dataset.src;
          delete img.dataset.srcset;
          delete img.dataset.loading;
          loadingCount--;

          // Masonry Layout aktualisieren
          const tile = img.closest('.photo-tile');
          if (tile) {
            imagesLoaded(tile, () => masonry.layout());
          }
        };

        tempImg.onerror = () => {
          console.warn('Fehler beim Laden des Bildes:', src);
          delete img.dataset.loading;
          loadingCount--;
        };

        // Start loading
        if (srcset) tempImg.srcset = srcset;
        tempImg.src = src;
      }

      /**
       * IntersectionObserver fÃ¼r performantes Lazy Loading
       */
      const lazyImageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && loadingCount < maxConcurrent) {
            const img = entry.target;
            if (img.dataset.src) {
              loadImage(img);
              lazyImageObserver.unobserve(img);  // Nicht mehr beobachten
            }
          }
        });
      }, {
        rootMargin: '300px 0px',  // 300px vor dem Sichtbereich laden
        threshold: 0.01
      });

      // Alle lazy Images registrieren
      const lazyImages = grid.querySelectorAll('img[data-src]');
      lazyImages.forEach(img => lazyImageObserver.observe(img));

      /**
       * Initial Layout nach eager Images
       */
      imagesLoaded(grid, { background: true }, () => {
        masonry.layout();
      });

      /**
       * Responsive Handling - Layout bei Resize neu berechnen
       */
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          // Gutter neu berechnen fÃ¼r responsive Breakpoints
          const newGutter = parseInt(
            getComputedStyle(document.documentElement).getPropertyValue('--gap')
          ) || 16;
          masonry.options.gutter = newGutter;
          masonry.layout();
        }, 250);
      });

      /**
       * Cleanup bei Page Unload
       */
      window.addEventListener('beforeunload', () => {
        lazyImageObserver.disconnect();
        masonry.destroy();
      });

      // Debug Info (optional - kann entfernt werden)
      console.info('ðŸ“¸ Photo Gallery initialized with Masonry.js');
      console.info('   Items:', grid.querySelectorAll('.photo-tile').length);
      console.info('   Eager loaded:', grid.querySelectorAll('img.loaded').length);
      console.info('   Lazy loading:', lazyImages.length);
    })();
  </script>
</main>
{{ end }}
