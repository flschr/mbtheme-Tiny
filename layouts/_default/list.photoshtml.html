{{ define "main" }}
<link rel="stylesheet" href="/css/photos.css">

<main class="photos content" aria-label="Foto-Archiv">

  {{ $pages := sort (where .Site.RegularPages "Type" "in" (slice "post" "photo")) "Date" "desc" }}
  {{ $.Scratch.Set "currentMonth" "" }}
  {{ $imageIndex := 0 }}

  {{/* Deutsche Monatsnamen */}}
  {{ $monthsDE := dict "January" "Januar" "February" "Februar" "March" "März" "April" "April" "May" "Mai" "June" "Juni" "July" "Juli" "August" "August" "September" "September" "October" "Oktober" "November" "November" "December" "Dezember" }}

  {{ range $p := $pages }}
    {{ $monthEN := $p.Date.Format "January" }}
    {{ $monthDE := index $monthsDE $monthEN }}
    {{ $dateFormatted := printf "%d. %s %s" $p.Date.Day $monthDE ($p.Date.Format "2006") }}
    {{ $dateISO := $p.Date.Format "2006-01-02" }}
    {{ $year := $p.Date.Format "2006" }}
    {{ $monthYear := printf "%s %s" $monthDE ($p.Date.Format "2006") }}

    {{/* Micro.blog Photos */}}
    {{ with $p.Params.photos }}
      {{ range $i, $url := . }}
        {{ $eager := lt $imageIndex 8 }}
        {{ $isMBPhotos := or (hasPrefix $url "https://micro.blog/photos/") (hasPrefix $url "http://micro.blog/photos/") }}
        {{ $src200 := "" }}{{ $src400 := "" }}

        {{ if $isMBPhotos }}
          {{ $src200 = replaceRE "/photos/[0-9]+/" "/photos/200/" $url }}
          {{ $src400 = replaceRE "/photos/[0-9]+/" "/photos/400/" $url }}
        {{ else }}
          {{ $src200 = $url }}
          {{ $src400 = $url }}
        {{ end }}

        {{/* Check if we need to start a new month section */}}
        {{ if ne $monthYear ($.Scratch.Get "currentMonth") }}
          {{ if ne ($.Scratch.Get "currentMonth") "" }}
            </div> {{/* Close previous grid */}}
            <h2 class="month-header">{{ $monthYear }}</h2>
          {{ end }}
          <div class="photos-grid e-content">
          {{ $.Scratch.Set "currentMonth" $monthYear }}
        {{ end }}

        <a class="photo-tile{{ if $p.Title }} has-title{{ else }} no-title{{ end }}"
           href="{{ $p.RelPermalink }}"
           aria-label="{{ if $p.Title }}{{ $p.Title }} – {{ end }}Foto vom {{ $dateFormatted }}">
          <img
            src="{{ $src200 }}"
            srcset="{{ $src200 }} 200w, {{ $src400 }} 400w"
            sizes="(max-width: 480px) 50vw, (max-width: 768px) 50vw, 25vw"
            alt="{{ if $p.Title }}{{ $p.Title }}{{ else }}Foto vom {{ $dateFormatted }}{{ end }}"
            loading="{{ if $eager }}eager{{ else }}lazy{{ end }}"
            decoding="async">
          <span class="date-badge">{{ $dateFormatted }}</span>
          {{ if $p.Title }}<span class="title-badge">{{ $p.Title }}</span>{{ end }}
        </a>

        {{ $imageIndex = add $imageIndex 1 }}
      {{ end }}
    {{ end }}

    {{/* Page Bundle Images */}}
    {{ $imgs := $p.Resources.ByType "image" }}
    {{ range $img := $imgs }}
      {{ $name := $img.Name | lower }}
      {{ if not (or (hasPrefix $name "hero") (in $name "og-") (in $name "open-graph") (in $name "social") (in $name "thumb")) }}
        {{ $w200 := $img.Resize "200x q85" }}
        {{ $w400 := $img.Resize "400x q85" }}
        {{ $eager := lt $imageIndex 8 }}

        {{/* Check if we need to start a new month section */}}
        {{ if ne $monthYear ($.Scratch.Get "currentMonth") }}
          {{ if ne ($.Scratch.Get "currentMonth") "" }}
            </div> {{/* Close previous grid */}}
            <h2 class="month-header">{{ $monthYear }}</h2>
          {{ end }}
          <div class="photos-grid e-content">
          {{ $.Scratch.Set "currentMonth" $monthYear }}
        {{ end }}

        <a class="photo-tile{{ if $p.Title }} has-title{{ else }} no-title{{ end }}"
           href="{{ $p.RelPermalink }}"
           aria-label="{{ if $p.Title }}{{ $p.Title }} – {{ end }}Foto vom {{ $dateFormatted }}">
          <img
            src="{{ $w200.RelPermalink }}"
            srcset="{{ $w200.RelPermalink }} 200w, {{ $w400.RelPermalink }} 400w"
            sizes="(max-width: 480px) 50vw, (max-width: 768px) 50vw, 25vw"
            alt="{{ if $p.Title }}{{ $p.Title }}{{ else }}Foto vom {{ $dateFormatted }}{{ end }}"
            loading="{{ if $eager }}eager{{ else }}lazy{{ end }}"
            decoding="async">
          <span class="date-badge">{{ $dateFormatted }}</span>
          {{ if $p.Title }}<span class="title-badge">{{ $p.Title }}</span>{{ end }}
        </a>

        {{ $imageIndex = add $imageIndex 1 }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Close last grid */}}
  {{ if ne ($.Scratch.Get "currentMonth") "" }}
    </div>
  {{ end }}

</main>
{{ end }}
