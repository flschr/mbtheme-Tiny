{{ define "main" }}
<main class="photos content" aria-label="Foto-Archiv">
  <style>
    :root {
      --gap: 4px;
      --tile-size: 140px;
      --max-width: 1200px;
      --radius: 4px;
    }

    .photos.content {
      overscroll-behavior-y: contain;
      -webkit-tap-highlight-color: transparent;
    }

    /* Instagram-Style Grid */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--tile-size), 1fr));
      gap: var(--gap);
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 0;
    }

    @media (max-width: 768px) {
      :root {
        --gap: 3px;
        --tile-size: 120px;
      }
    }

    @media (max-width: 480px) {
      :root {
        --gap: 2px;
        --tile-size: 100px;
      }
    }

    /* Photo Tiles */
    .photo-tile {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
      background: #f3f4f6;
      cursor: pointer;
      border-radius: var(--radius);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .photo-tile:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(0,0,0,.15);
      z-index: 1;
    }

    .photo-tile:active {
      transform: scale(0.98);
    }

    .photo-tile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: opacity 0.3s ease;
    }

    /* LQIP Blur Effect */
    .photo-tile img.lqip {
      filter: blur(10px);
      transform: scale(1.05);
    }

    .photo-tile img.loaded {
      filter: none;
      transform: scale(1);
    }

    /* Hover Overlay */
    .photo-tile::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, transparent 60%, rgba(0,0,0,.5) 100%);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }

    .photo-tile:hover::after {
      opacity: 1;
    }

    /* Date Badge */
    .date-badge {
      position: absolute;
      bottom: 0.5rem;
      left: 0.5rem;
      padding: 0.35rem 0.6rem;
      font-size: 0.75rem;
      line-height: 1;
      color: #fff;
      background: rgba(0,0,0,.7);
      border-radius: 4px;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
      backdrop-filter: blur(4px);
    }

    .photo-tile:hover .date-badge {
      opacity: 1;
      transform: translateY(0);
    }

    /* Loading Indicator */
    .loading-indicator {
      text-align: center;
      padding: 2rem;
      color: #666;
      font-size: 0.9rem;
    }

    /* Focus States */
    .photo-tile:focus-visible {
      outline: 3px solid #3b82f6;
      outline-offset: 2px;
    }

    @media (prefers-color-scheme: dark) {
      .photo-tile {
        background: #1f2937;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .photo-tile,
      .photo-tile img,
      .date-badge {
        transition: none;
      }
    }
  </style>

  <div class="photo-grid" id="photoGrid">
    {{ $pages := sort (where .Site.RegularPages "Type" "in" (slice "post" "photo")) "Date" "desc" }}
    {{ $imageIndex := 0 }}

    {{ range $p := $pages }}
      {{ $dateFormatted := $p.Date.Format "2. January 2006" }}
      {{ $dateISO := $p.Date.Format "2006-01-02" }}
      {{ $year := $p.Date.Format "2006" }}

      {{ with $p.Params.photos }}
        {{ range $i, $url := . }}
          {{ $eager := lt $imageIndex 12 }}
          {{ $isMBPhotos := or (hasPrefix $url "https://micro.blog/photos/") (hasPrefix $url "http://micro.blog/photos/") }}
          {{ $src300 := "" }}{{ $src600 := "" }}{{ $tiny := "" }}

          {{ if $isMBPhotos }}
            {{ $src300 = replaceRE `/photos/[^/]+/` "/photos/200x/" $url }}
            {{ $src600 = replaceRE `/photos/[^/]+/` "/photos/400x/" $url }}
            {{ $tiny = replaceRE `/photos/[^/]+/` "/photos/40x/" $url }}
          {{ else }}
            {{ $encoded := $url | urlquery }}
            {{ $src300 = printf "https://micro.blog/photos/200x/%s" $encoded }}
            {{ $src600 = printf "https://micro.blog/photos/400x/%s" $encoded }}
            {{ $tiny = printf "https://micro.blog/photos/40x/%s" $encoded }}
          {{ end }}

          <a class="photo-tile"
             href="{{ $p.RelPermalink }}"
             aria-label="{{ $dateFormatted }}"
             data-date="{{ $dateFormatted }}"
             data-year="{{ $year }}">
            {{ if $eager }}
              <img
                src="{{ $src300 }}"
                srcset="{{ $src300 }} 200w, {{ $src600 }} 400w"
                sizes="(max-width: 768px) 50vw, 33vw"
                alt="{{ $dateFormatted }}"
                loading="eager"
                decoding="async"
                class="loaded">
            {{ else }}
              <img
                src="{{ $tiny }}"
                data-src="{{ $src300 }}"
                data-srcset="{{ $src300 }} 200w, {{ $src600 }} 400w"
                sizes="(max-width: 768px) 50vw, 33vw"
                alt="{{ $dateFormatted }}"
                decoding="async"
                class="lqip">
            {{ end }}
            <span class="date-badge">{{ $dateFormatted }}</span>
          </a>

          {{ $imageIndex = add $imageIndex 1 }}
        {{ end }}
      {{ end }}

      {{ $imgs := $p.Resources.ByType "image" }}
      {{ range $img := $imgs }}
        {{ $name := $img.Name | lower }}
        {{ if not (or (hasPrefix $name "hero") (in $name "og-") (in $name "open-graph") (in $name "social") (in $name "thumb")) }}
          {{ $w300 := $img.Fit "200x200 q85" }}
          {{ $w600 := $img.Fit "400x400 q85" }}
          {{ $w40 := $img.Fit "40x40 q50" }}
          {{ $eager := lt $imageIndex 12 }}

          <a class="photo-tile"
             href="{{ $p.RelPermalink }}"
             aria-label="{{ $dateFormatted }}"
             data-date="{{ $dateFormatted }}"
             data-year="{{ $year }}">
            {{ if $eager }}
              <img
                src="{{ $w300.RelPermalink }}"
                srcset="{{ $w300.RelPermalink }} 200w, {{ $w600.RelPermalink }} 400w"
                sizes="(max-width: 768px) 50vw, 33vw"
                alt="{{ $dateFormatted }}"
                loading="eager"
                decoding="async"
                class="loaded">
            {{ else }}
              <img
                src="{{ $w40.RelPermalink }}"
                data-src="{{ $w300.RelPermalink }}"
                data-srcset="{{ $w300.RelPermalink }} 200w, {{ $w600.RelPermalink }} 400w"
                sizes="(max-width: 768px) 50vw, 33vw"
                alt="{{ $dateFormatted }}"
                decoding="async"
                class="lqip">
            {{ end }}
            <span class="date-badge">{{ $dateFormatted }}</span>
          </a>

          {{ $imageIndex = add $imageIndex 1 }}
        {{ end }}
      {{ end }}
    {{ end }}
  </div>

  <script>
    // Viewport-basiertes Lazy Loading - nur sichtbare Bilder
    (function() {
      'use strict';

      const lazyImages = document.querySelectorAll('img.lqip[data-src]');
      if (!lazyImages.length) return;

      let loadingCount = 0;
      const maxConcurrent = 4;

      // Lade ein einzelnes Bild
      function loadImage(img) {
        if (img.dataset.loading || !img.dataset.src) return;

        img.dataset.loading = 'true';
        loadingCount++;

        const src = img.dataset.src;
        const srcset = img.dataset.srcset;
        const fullImg = new Image();

        fullImg.onload = fullImg.onerror = () => {
          img.src = src;
          if (srcset) img.srcset = srcset;
          img.classList.remove('lqip');
          img.classList.add('loaded');

          delete img.dataset.src;
          delete img.dataset.srcset;
          delete img.dataset.loading;

          loadingCount--;
        };

        if (srcset) fullImg.srcset = srcset;
        fullImg.src = src;
      }

      // IntersectionObserver - nur Bilder nahe dem Viewport
      const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && loadingCount < maxConcurrent) {
            const img = entry.target;
            if (img.dataset.src && !img.dataset.loading) {
              loadImage(img);
            }
          }
        });
      }, {
        rootMargin: '150px 0px',
        threshold: 0.01
      });

      // Beobachte alle Bilder
      lazyImages.forEach(img => imageObserver.observe(img));

      // Cleanup
      window.addEventListener('beforeunload', () => {
        imageObserver.disconnect();
      });
    })();
  </script>
</main>
{{ end }}
