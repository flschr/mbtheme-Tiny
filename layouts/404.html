{{ define "title" }}
404 - Seite nicht gefunden | {{ .Site.Title }}
{{ end }}

{{ define "main" }}
<div class="page">
  <article class="post-content">
    <p>Very oooopsi! Diese Seite gibt es leider nicht. Versuch gern einen der folgenden Artikel:</p>

    <div id="random-recommendations" class="random-recommendations" aria-live="polite">
      <p>Lädt Empfehlungen …</p>
    </div>

    <nav class="not-found-cta" aria-label="Alternative Ziele">
      <a class="not-found-cta__link" href="/">Zur Startseite</a>
      <a class="not-found-cta__link" href="/archive/">Zum Archiv</a>
      <a class="not-found-cta__link" href="/tags/">Zu den Tags</a>
      <a class="not-found-cta__link" href="/random">Jetzt zufälligen Artikel öffnen</a>
    </nav>

    <div style="margin: 2em 0;">
      <img src="/img/404.webp" alt="Ein Einhorn erbricht einen Regenbogen, satter 404!" loading="lazy" decoding="async" width="1200" height="900" style="width: 100%; height: auto; border-radius: var(--radius-default);">
    </div>

    <div class="countdown-wrapper" role="status" aria-live="polite">
      <span class="countdown-text">Du wirst in <span id="countdown-value">9</span> Sekunden zu einem zufälligen Artikel weitergeleitet …</span>
      <div class="countdown-meter" aria-hidden="true">
        <div class="countdown-meter__fill" id="countdown-progress"></div>
      </div>
    </div>

    <noscript>
      <p class="countdown-noscript">JavaScript ist deaktiviert. <a href="/random">Hier direkt einen zufälligen Artikel öffnen.</a></p>
    </noscript>
  </article>
</div>

{{/* Generiere Posts-Daten als JSON für JavaScript */}}
<script type="application/json" id="posts-data">
{{- $posts := slice -}}
{{- range .Site.RegularPages -}}
  {{- if not .Draft -}}
    {{- $tags := slice -}}
    {{- range .Params.tags -}}
      {{- $tags = $tags | append (lower .) -}}
    {{- end -}}
    {{- $post := dict "title" .Title "url" .Permalink "date" (.Date.Format "2. Jan 2006") "datetime" (.Date.Format "2006-01-02") "tags" $tags "summary" (.Summary | plainify | truncate 100) -}}
    {{- $posts = $posts | append $post -}}
  {{- end -}}
{{- end -}}
{{- $posts | jsonify -}}
</script>

<script>
(function() {
  // Lade Posts-Daten
  const postsDataElement = document.getElementById('posts-data');
  if (!postsDataElement) {
    console.error('404 - posts-data element not found!');
    return;
  }

  let postsData = [];
  try {
    postsData = JSON.parse(postsDataElement.textContent);
  } catch (e) {
    console.error('404 - Error parsing posts data:', e);
    return;
  }

  if (!postsData || postsData.length === 0) {
    console.warn('404 - No posts data available!');
    return;
  }

  // Wähle 3 zufällige Posts aus
  function getRandomPosts(posts, count) {
    const shuffled = [...posts].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, Math.min(count, posts.length));
  }

  // Zeige zufällige Empfehlungen an
  function displayRecommendations() {
    const recommendations = getRandomPosts(postsData, 3);
    const recommendationsElement = document.getElementById('random-recommendations');

    if (!recommendationsElement) {
      console.warn('404 - recommendations element not found!');
      return;
    }

    if (!recommendations || recommendations.length === 0) {
      recommendationsElement.textContent = 'Keine Empfehlungen verfügbar';
      return;
    }

    const list = document.createElement('ul');
    list.className = 'random-recommendations__list';

    recommendations.forEach(post => {
      const item = document.createElement('li');
      item.className = 'random-recommendations__item';

      if (post.url && post.title) {
        const link = document.createElement('a');
        link.className = 'random-recommendations__link';
        link.href = post.url;
        link.textContent = post.title;
        item.appendChild(link);
      } else if (post.title) {
        const title = document.createElement('span');
        title.textContent = post.title;
        item.appendChild(title);
      }

      if (post.summary) {
        const summary = document.createElement('p');
        summary.className = 'random-recommendations__summary';
        summary.textContent = post.summary;
        item.appendChild(summary);
      }

      list.appendChild(item);
    });

    recommendationsElement.replaceChildren(list);
  }

  // Countdown und Auto-Redirect
  function startCountdown() {
    const totalSeconds = 9;
    let seconds = totalSeconds;
    const countdownElement = document.getElementById('countdown-value');
    const progressElement = document.getElementById('countdown-progress');

    if (progressElement) {
      progressElement.style.width = '0%';
    }

    const interval = setInterval(() => {
      seconds--;
      if (countdownElement) {
        countdownElement.textContent = seconds;
      }

      if (progressElement) {
        const elapsed = totalSeconds - seconds;
        const progress = Math.min(Math.max(elapsed / totalSeconds, 0), 1) * 100;
        progressElement.style.width = `${progress}%`;
      }

      if (seconds <= 0) {
        clearInterval(interval);
        window.location.href = '/random';
      }
    }, 1000);
  }

  // Führe aus, wenn DOM bereit ist
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      displayRecommendations();
      startCountdown();
    });
  } else {
    displayRecommendations();
    startCountdown();
  }
})();
</script>
{{ end }}
