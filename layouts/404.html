{{ define "title" }}
404 - Seite nicht gefunden | {{ .Site.Title }}
{{ end }}

{{ define "main" }}
<div class="page">
  <article class="post-content">
    <p>Very oooopsi! Diese Seite gibt es leider nicht.</p>
    <p>Hier ist <a href="/suche">die Suche</a> oder probier es einfach mit einem <a href="/random">zufälligen Artikel</a>.</p>

    <div style="margin: 2em 0;">
      <img src="/img/404.webp" alt="Ein Einhorn erbricht einen Regenbogen, satter 404!" loading="lazy" style="width: 100%; height: auto; border-radius: var(--radius-default);">
    </div>

    {{/* Zufällige Artikelempfehlungen */}}
    <div id="recommendations">
      <h2>Vielleicht interessieren dich diese Artikel:</h2>
      <ul class="post-list" id="recommendation-list"></ul>
    </div>

    <p style="text-align: center; margin-top: 2em; color: var(--accent2);">
      Du wirst in <span id="countdown">9</span> Sekunden zu einem zufälligen Artikel weitergeleitet...
    </p>
  </article>
</div>

{{/* Generiere Posts-Daten als JSON für JavaScript */}}
<script type="application/json" id="posts-data">
{{- $posts := slice -}}
{{- range .Site.RegularPages -}}
  {{- if not .Draft -}}
    {{- $tags := slice -}}
    {{- range .Params.tags -}}
      {{- $tags = $tags | append (lower .) -}}
    {{- end -}}
    {{- $post := dict "title" .Title "url" .Permalink "date" (.Date.Format "2. Jan 2006") "datetime" (.Date.Format "2006-01-02") "tags" $tags "summary" (.Summary | plainify | truncate 100) -}}
    {{- $posts = $posts | append $post -}}
  {{- end -}}
{{- end -}}
{{- $posts | jsonify -}}
</script>

<script>
(function() {
  // Lade Posts-Daten
  const postsDataElement = document.getElementById('posts-data');
  if (!postsDataElement) {
    console.error('404 - posts-data element not found!');
    return;
  }

  let postsData = [];
  try {
    postsData = JSON.parse(postsDataElement.textContent);
  } catch (e) {
    console.error('404 - Error parsing posts data:', e);
    return;
  }

  if (!postsData || postsData.length === 0) {
    console.warn('404 - No posts data available!');
    return;
  }

  // Wähle 3 zufällige Posts aus
  function getRandomPosts(posts, count) {
    const shuffled = [...posts].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, Math.min(count, posts.length));
  }

  // Zeige zufällige Empfehlungen an
  function displayRecommendations() {
    const recommendations = getRandomPosts(postsData, 3);
    const listElement = document.getElementById('recommendation-list');

    recommendations.forEach(post => {
      const li = document.createElement('li');
      li.className = 'post-item';
      li.innerHTML = `
        <div class="post-preview">
          <a href="${post.url}" class="post-date u-url">
            <time class="dt-published" datetime="${post.datetime}">${post.date}</time> ∞
          </a>
          ${post.title ? `<h2 class="post-title p-name"><a href="${post.url}">${post.title}</a></h2>` : ''}
        </div>
      `;
      listElement.appendChild(li);
    });
  }

  // Countdown und Auto-Redirect
  function startCountdown() {
    let seconds = 9;
    const countdownElement = document.getElementById('countdown');

    const interval = setInterval(() => {
      seconds--;
      if (countdownElement) {
        countdownElement.textContent = seconds;
      }

      if (seconds <= 0) {
        clearInterval(interval);
        window.location.href = '/random';
      }
    }, 1000);
  }

  // Führe aus, wenn DOM bereit ist
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      displayRecommendations();
      startCountdown();
    });
  } else {
    displayRecommendations();
    startCountdown();
  }
})();
</script>
{{ end }}
